{% extends "base.html" %}

{% block title %}Task Manager{% endblock %}

{% block content %}
    <div class="container-fluid main-container">
        <div class="row">
            <!-- Left Column: Add Task, Task Stats -->
            <div class="col-md-2 left-sidebar">
                <div class="card p-3 mb-3 mt-0">
                    <h5 class="mb-3">Add New Task</h5>
                    <a href="/add" class="btn btn-primary btn-block">Add Task</a>
                </div>
                <div class="card p-3 mb-3">
                    <h5 class="mb-3">Task Stats</h5>
                    <ul class="list-unstyled">
                        <li class="d-flex justify-content-between"><span>Total:</span> <strong>{{ stats.total }}</strong></li>
                        <li class="d-flex justify-content-between"><span>To-Do:</span> <strong>{{ stats.ToDo }}</strong></li>
                        <li class="d-flex justify-content-between"><span>In Progress:</span> <strong>{{ stats.InProgress }}</strong></li>
                        <li class="d-flex justify-content-between"><span>Completed:</span> <strong>{{ stats.Completed }}</strong></li>
                    </ul>
                    <hr style="border-color: var(--border-color);">
                    <h5 class="mb-3">Quick Filters</h5>
                    <a href="/?filter_by_status=all" class="sidebar-link {% if filter_by_status == 'all' %}active{% endif %}">All Tasks</a>
                    <a href="/?filter_by_status=ToDo" class="sidebar-link {% if filter_by_status == 'ToDo' %}active{% endif %}">To-Do</a>
                    <a href="/?filter_by_status=InProgress" class="sidebar-link {% if filter_by_status == 'InProgress' %}active{% endif %}">In Progress</a>
                    <a href="/?filter_by_status=Completed" class="sidebar-link {% if filter_by_status == 'Completed' %}active{% endif %}">Completed</a>
                    <hr style="border-color: var(--border-color);">
                    <form method="get" action="/">
                        <div class="form-group">
                            <label for="sort_by">Sort by:</label>
                            <select name="sort_by" id="sort_by" class="form-control form-control-sm" onchange="this.form.submit()">
                                <option value="id" {% if sort_by == 'id' %}selected{% endif %}>ID</option>
                                <option value="start_date" {% if sort_by == 'start_date' %}selected{% endif %}>Start Date</option>
                                <option value="end_date" {% if sort_by == 'end_date' %}selected{% endif %}>End Date</option>
                                <option value="status" {% if sort_by == 'status' %}selected{% endif %}>Status</option>
                            </select>
                        </div>
                    </form>
                </div>
                <div class="card p-3 mt-3">
                    <h5 class="mb-3">Chat with MCP</h5>
                    <div id="chat-box" style="height: 200px; overflow-y: scroll; border: 1px solid var(--border-color); padding: 10px; border-radius: 5px; margin-bottom: 10px;">
                    </div>
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" placeholder="Type a message...">
                        <div class="input-group-append">
                            <button id="chat-send" class="btn btn-primary">Send</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Middle Column: Task Dashboard -->
            <div class="col-md-7">
                <div class="d-flex justify-content-between align-items-center mb-4 mt-0">
                    <h1 class="mb-0 h2">Task Dashboard</h1>
                </div>
                <div class="card">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Description</th>
                                <th>Start Date</th>
                                <th>End Date</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for task in tasks %}
                            <tr>
                                <td>{{ task.title }}</td>
                                <td>{{ task.description }}</td>
                                <td>{{ task.start_date }}</td>
                                <td>{{ task.end_date }}</td>
                                <td>
                                    <span class="badge badge-{{ task.status }} mr-2">{{ task.status }}</span>
                                    <select class="form-control form-control-sm status-dropdown d-inline-block w-auto" data-task-id="{{ task.id }}">
                                        <option value="ToDo" {% if task.status == 'ToDo' %}selected{% endif %}>ToDo</option>
                                        <option value="InProgress" {% if task.status == 'InProgress' %}selected{% endif %}>In Progress</option>
                                        <option value="Completed" {% if task.status == 'Completed' %}selected{% endif %}>Completed</option>
                                    </select>
                                </td>
                                <td>
                                    <a href="/edit/{{ task.id }}" class="btn btn-warning btn-sm">Edit</a>
                                    <a href="/delete/{{ task.id }}" class="btn btn-danger btn-sm" onclick="return confirm('Are you sure you want to delete this task?');">Delete</a>
                                </td>
                            </tr>
                            {% else %}
                            <tr>
                                <td colspan="6" class="text-center py-5" style="color: var(--text-muted-color);">No tasks match your criteria.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <nav aria-label="Page navigation">
                    <ul class="pagination justify-content-center">
                        {% if total_pages > 1 %}
                            <li class="page-item {% if page == 1 %}disabled{% endif %}">
                                <a class="page-link" href="/?page={{ page - 1 }}&sort_by={{ sort_by }}&filter_by_status={{ filter_by_status }}">Previous</a>
                            </li>
                            {% for i in range(1, total_pages + 1) %}
                                <li class="page-item {% if i == page %}active{% endif %}">
                                    <a class="page-link" href="/?page={{ i }}&sort_by={{ sort_by }}&filter_by_status={{ filter_by_status }}"> {{ i }}</a>
                                </li>
                            {% endfor %}
                            <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                                <a class="page-link" href="/?page={{ page + 1 }}&sort_by={{ sort_by }}&filter_by_status={{ filter_by_status }}">Next</a>
                            </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>

            <!-- Right Column: Reminders, Calendar, Task Status Distribution -->
            <div class="col-md-3 right-sidebar">
                <div class="card p-3 mb-3 mt-0">
                    {% if urgent_tasks or approaching_deadline_tasks %}
                    <div class="mb-3">
                        <h5 class="h5">Reminders</h5>
                        {% if urgent_tasks %}
                        <div class="alert alert-danger small">
                            <h6 class="alert-heading">Urgent (Past Due)</h6>
                            <ul class="mb-0 pl-3">
                                {% for task in urgent_tasks %}
                                <li>{{ task.title }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                        {% if approaching_deadline_tasks %}
                        <div class="alert alert-warning small">
                            <h6 class="alert-heading">Approaching Deadline</h6>
                            <ul class="mb-0 pl-3">
                                {% for task in approaching_deadline_tasks %}
                                <li>{{ task.title }}</li>
                                {% endfor %}
                            </ul>
                        </div>
                        {% endif %}
                    </div>
                    <hr style="border-color: var(--border-color);">
                    {% endif %}
                    <div id="calendar"></div>
                </div>
                <div class="card p-3 mb-3">
                    <h5 class="mb-3">Task Status Distribution</h5>
                    <canvas id="task-status-chart"></canvas>
                </div>
            </div>
        </div>
    </div>
{% block scripts %}
    <script>
        document.addEventListener('DOMContentLoaded', function () {

            // Status update logic
            const statusDropdowns = document.querySelectorAll('.status-dropdown');
            statusDropdowns.forEach(dropdown => {
                dropdown.addEventListener('change', function () {
                    const taskId = this.dataset.taskId;
                    const newStatus = this.value;

                    fetch(`/api/task/${taskId}/status`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ status: newStatus }),
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            console.log('Status updated successfully');
                            location.reload(); // Reload to see changes reflected everywhere
                        } else {
                            console.error('Error updating status:', data.error);
                            alert('Error updating status: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('An unexpected error occurred.');
                    });
                });
            });

            // Sidebar toggler for small screens
            const sidebarToggler = document.getElementById('sidebar-toggler');
            sidebarToggler.addEventListener('click', function() {
                document.body.classList.toggle('sidebars-visible');
            });

            // Calendar Initialization
            var calendarEl = document.getElementById('calendar');
            var calendar = new FullCalendar.Calendar(calendarEl, { // Moved FullCalendar script include to base.html
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'title',
                    center: '',
                    right: 'prev,next today'
                },
                events: '/api/tasks/events',
                height: '300px',
                dayMaxEvents: true,
                eventClick: function(info) {
                    window.location.href = '/edit/' + info.event.id;
                }
            });
            calendar.render();

            // Chat functionality
            const chatBox = document.getElementById('chat-box');
            const chatInput = document.getElementById('chat-input');
            const chatSend = document.getElementById('chat-send');

            chatSend.addEventListener('click', function() {
                const message = chatInput.value;
                if (message.trim() === '') {
                    return;
                }

                appendMessage('You', message);
                chatInput.value = '';

                fetch('/api/mcp/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message }),
                })
                .then(response => response.json())
                .then(data => {
                    appendMessage('MCP', data.reply);
                })
                .catch(error => {
                    console.error('Error:', error);
                    appendMessage('Error', 'An unexpected error occurred.');
                });
            });

            function appendMessage(sender, message) {
                const messageElement = document.createElement('div');
                messageElement.innerHTML = `<strong>${sender}:</strong> ${message}`;
                chatBox.appendChild(messageElement);
                chatBox.scrollTop = chatBox.scrollHeight;
            }
        });
        // FullCalendar script include
        document.write("<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.9/index.global.min.js'></script>");
    </script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            fetch('/api/tasks/stats')
                .then(response => response.json())
                .then(data => {
                    const ctx = document.getElementById('task-status-chart').getContext('2d');
                    new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(data),
                            datasets: [{
                                label: '# of Tasks',
                                data: Object.values(data),
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255, 99, 132, 1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                });
        });
    </script>
{% endblock %}
{% endblock %}

